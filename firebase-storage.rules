rules_version = '2';

// Firebase Storage Security Rules for VibeCode SaaS Template
service firebase.storage {
  match /b/{bucket}/o {
    // Users can only access their own files
    match /users/{userId}/files/{allPaths=**} {
      // Allow authenticated users to read, write, and delete their own files
      allow read, write, delete: if request.auth != null 
                                 && request.auth.uid == userId;
      
      // Additional validation for uploads
      allow create: if request.auth != null 
                    && request.auth.uid == userId
                    && validateFileUpload();
      
      // Additional validation for updates
      allow update: if request.auth != null 
                    && request.auth.uid == userId
                    && validateFileUpdate();
    }
    
    // Deny all other access
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
  
  // Validation functions
  function validateFileUpload() {
    // Check file size limits (50MB for Pro, 10MB for Free)
    // Note: User subscription type should be validated on the server side
    return request.resource.size <= 50 * 1024 * 1024
           && request.resource.contentType != null
           && isValidFileType(request.resource.contentType);
  }
  
  function validateFileUpdate() {
    // Allow updates only if the file size doesn't exceed limits
    return request.resource.size <= 50 * 1024 * 1024
           && request.resource.contentType != null
           && isValidFileType(request.resource.contentType);
  }
  
  function isValidFileType(contentType) {
    // Allow common file types
    return contentType.matches('image/.*') ||
           contentType.matches('video/.*') ||
           contentType.matches('audio/.*') ||
           contentType.matches('application/pdf') ||
           contentType.matches('application/msword') ||
           contentType.matches('application/vnd.openxmlformats-officedocument.wordprocessingml.document') ||
           contentType.matches('application/vnd.ms-excel') ||
           contentType.matches('application/vnd.openxmlformats-officedocument.spreadsheetml.sheet') ||
           contentType.matches('application/vnd.ms-powerpoint') ||
           contentType.matches('application/vnd.openxmlformats-officedocument.presentationml.presentation') ||
           contentType.matches('text/.*') ||
           contentType.matches('application/json') ||
           contentType.matches('application/zip') ||
           contentType.matches('application/x-zip-compressed') ||
           contentType.matches('application/octet-stream');
  }
}

// Instructions for deployment:
// 1. Copy these rules to your Firebase console under Storage > Rules
// 2. Or use Firebase CLI: firebase deploy --only storage
// 3. Make sure to test the rules in the Firebase console simulator
// 
// Security considerations:
// - Files are isolated by user ID
// - File size limits are enforced at the storage level
// - File type validation prevents malicious uploads
// - Only authenticated users can access files
// - Users can only access their own files